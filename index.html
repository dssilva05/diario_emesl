<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Di√°rio de Bordo - E. M. Etelvino Souza Lima</title>
    <style>
        :root { --blue: #0d47a1; --gold: #ffd600; --glass: rgba(255, 255, 255, 0.95); }
        
        body { 
            font-family: 'Segoe UI', sans-serif; margin: 0; 
            background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1497633762265-9d179a990aa6?q=80') center/cover fixed;
            min-height: 100vh;
        }

        /* Cabe√ßalho */
        header { 
            background: var(--blue); color: white; padding: 15px 3%; 
            display: flex; align-items: center; justify-content: space-between; 
            border-bottom: 4px solid var(--gold); box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .img-topo { width: 80px; height: 80px; object-fit: contain; background: white; border-radius: 8px; padding: 5px; }
        .escola-txt { text-align: center; flex-grow: 1; padding: 0 15px; }
        .escola-txt h1 { margin: 0; font-size: 20px; text-transform: uppercase; }
        .escola-txt p { margin: 5px 0 0; font-size: 12px; opacity: 0.9; line-height: 1.4; }

        /* Acesso */
        .auth-wrapper { display: flex; justify-content: center; align-items: center; padding: 40px 20px; }
        .box-auth { background: white; padding: 30px; border-radius: 12px; width: 100%; max-width: 350px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); text-align: center; }
        
        /* Sistema */
        .container { max-width: 650px; margin: 20px auto; padding: 15px; }
        .tabs { display: flex; background: rgba(255,255,255,0.2); border-radius: 12px 12px 0 0; backdrop-filter: blur(10px); padding: 5px 5px 0; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; color: white; cursor: pointer; font-weight: bold; border-radius: 8px 8px 0 0; }
        .tab-btn.active { background: var(--glass); color: var(--blue); }
        .card { background: var(--glass); padding: 25px; border-radius: 0 0 12px 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }

        .hidden { display: none !important; }
        label { display: block; margin-top: 15px; font-weight: bold; color: #333; }
        input, select, textarea, .btn-main { width: 100%; padding: 12px; margin-top: 8px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 15px; }
        
        .btn-main { background: var(--blue); color: white; font-weight: bold; cursor: pointer; border: none; transition: 0.3s; }
        .btn-main:hover { background: #1565c0; }
        .btn-link { background: none; border: none; color: var(--blue); text-decoration: underline; cursor: pointer; margin-top: 15px; font-size: 14px; width: auto; }

        .item-ocorrencia { background: white; padding: 15px; border-left: 5px solid var(--blue); margin-top: 15px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; }

        /* Estilo de Impress√£o */
        @media print {
            body { background: white !important; }
            header { display: flex !important; border-bottom: 2px solid #000 !important; color: black !important; }
            .img-topo { filter: grayscale(1); }
            .tabs, .btn-main, label, select, .box-auth, button, .btn-link { display: none !important; }
            .container { max-width: 100% !important; margin: 0 !important; padding: 0 !important; }
            .card { background: white !important; box-shadow: none !important; padding: 0 !important; }
            #areaImpressao { display: block !important; }
            .item-ocorrencia { border: 1px solid #ccc !important; page-break-inside: avoid; }
        }
    </style>
</head>
<body>

<header>
    <img src="https://lh3.googleusercontent.com/u/0/d/150ASiCvLEftWk_IhH0GIVMyURJe76Epn" alt="Prefeitura" class="img-topo">
    <div class="escola-txt">
        <h1>Escola Municipal Etelvino Souza Lima</h1>
        <p>Avenida Engenheiro Felipe Gabrich, 19, Santa Matilde, Santa Luzia - MG.<br>CEP: 33025-220</p>
    </div>
    <img src="https://lh3.googleusercontent.com/u/0/d/1gaz-GsE-IJImjjWwG3Im4XoMLOraCSTh" alt="Escola" class="img-topo">
</header>

<div id="secaoAcesso" class="auth-wrapper">
    <div id="telaLogin" class="box-auth">
        <h2 style="color:var(--blue)">üîí Login</h2>
        <input type="text" id="userLogin" placeholder="Usu√°rio">
        <input type="password" id="passLogin" placeholder="Senha">
        <button class="btn-main" onclick="executarLogin()">Entrar</button>
        <button class="btn-link" onclick="irPara('telaCadastro')">N√£o tenho conta? Cadastre-se</button>
    </div>

    <div id="telaCadastro" class="box-auth hidden">
        <h2 style="color:var(--blue)">üìù Cadastro</h2>
        <p style="font-size:11px">Apenas CPFs autorizados.</p>
        <input type="text" id="cadCpf" placeholder="CPF (apenas n√∫meros)">
        <input type="text" id="cadNasc" placeholder="Nascimento (DD/MM/AAAA)">
        <input type="text" id="cadUser" placeholder="Criar Usu√°rio">
        <input type="password" id="cadPass" placeholder="Criar Senha">
        <button class="btn-main" onclick="executarCadastro()">Finalizar Cadastro</button>
        <button class="btn-link" onclick="irPara('telaLogin')">Voltar ao Login</button>
    </div>
</div>

<div id="conteudoDiario" class="container hidden">
    <div class="tabs">
        <button id="t1" class="tab-btn active" onclick="tab(1)">üìù INCLUIR</button>
        <button id="t2" class="tab-btn" onclick="tab(2)">üîç CONSULTAR</button>
        <button onclick="location.reload()" style="background:none; color:white; flex:0.3; cursor:pointer">Sair</button>
    </div>

    <div class="card">
        <div id="aba1">
            <label>Professor(a):</label>
            <input type="text" id="nomeProfLogado" readonly style="background:#e9ecef; font-weight:bold;">
            
            <label>Turma:</label>
            <select id="selTurma" onchange="atualizarAlunos('selTurma', 'selAluno')">
                <option value="">Selecione...</option>
                <option>9¬∫ Ano A</option>
                <option>1¬™ S√©rie B</option>
            </select>
            
            <label>Aluno:</label>
            <select id="selAluno"><option value="">Selecione a turma...</option></select>
            
            <label>Relato da Ocorr√™ncia:</label>
            <textarea id="relatoTexto" rows="5" placeholder="Digite aqui os detalhes..."></textarea>
            
            <button class="btn-main" onclick="gravarOcorrencia()">Gravar no Di√°rio</button>
        </div>

        <div id="aba2" class="hidden">
            <label>1. Selecione a Turma:</label>
            <select id="selTurmaCons" onchange="atualizarAlunos('selTurmaCons', 'selAlunoCons')">
                <option value="">Selecione...</option>
                <option>9¬∫ Ano A</option>
                <option>1¬™ S√©rie B</option>
            </select>

            <label>2. Selecione o Aluno:</label>
            <select id="selAlunoCons"><option value="">Aguardando turma...</option></select>
            
            <button class="btn-main" style="background:#2e7d32; margin-top:20px;" onclick="consultarHistorico()">üîç Buscar Hist√≥rico</button>
            
            <div id="areaImpressao">
                <div id="resConsulta"></div>
            </div>
            
            <button class="btn-main" id="btnImp" style="background:#444; display:none; margin-top:20px" onclick="window.print()">üñ®Ô∏è Gerar PDF / Imprimir</button>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz69grSXw5sBpm39kV1UB7rn8B4ycQdvf2CET6VtbK3TLBVh1RzrcrnpxfNUDcZ5vobbg/exec"; 

    const ALUNOS = { 
        "9¬∫ Ano A": ["Ana Beatriz", "Bruno Silva", "Carlos Eduardo", "Turma Toda"],
        "1¬™ S√©rie B": ["Daniela Oliveira", "Eduardo Souza", "Fernanda Lima", "Turma Toda"] 
    };

    function irPara(id) {
        document.getElementById('telaLogin').classList.add('hidden');
        document.getElementById('telaCadastro').classList.add('hidden');
        document.getElementById(id).classList.remove('hidden');
    }

    function tab(n) {
        document.getElementById('aba1').classList.toggle('hidden', n !== 1);
        document.getElementById('aba2').classList.toggle('hidden', n !== 2);
        document.getElementById('t1').classList.toggle('active', n === 1);
        document.getElementById('t2').classList.toggle('active', n === 2);
        if(n === 2) {
             document.getElementById('resConsulta').innerHTML = "";
             document.getElementById('btnImp').style.display = "none";
        }
    }

    function atualizarAlunos(idTurma, idAluno) {
        const t = document.getElementById(idTurma).value;
        const s = document.getElementById(idAluno);
        s.innerHTML = "";
        if(ALUNOS[t]) {
            s.add(new Option("Selecione o Aluno...", ""));
            ALUNOS[t].forEach(a => s.add(new Option(a, a)));
        } else {
            s.add(new Option("Selecione a turma...", ""));
        }
    }

    async function executarLogin() {
        const u = document.getElementById('userLogin').value;
        const s = document.getElementById('passLogin').value;
        if(!u || !s) return alert("Preencha usu√°rio e senha.");
        try {
            const res = await fetch(`${SCRIPT_URL}?acao=login&usuario=${u}&senha=${s}`);
            const dados = await res.json();
            if (dados.status === "Autorizado") {
                document.getElementById('secaoAcesso').classList.add('hidden');
                document.getElementById('conteudoDiario').classList.remove('hidden');
                document.getElementById('nomeProfLogado').value = dados.nome;
            } else { alert("Usu√°rio ou senha incorretos."); }
        } catch (e) { alert("Erro de conex√£o."); }
    }

    async function executarCadastro() {
        const p = new URLSearchParams();
        p.append('acao', 'cadastrar');
        p.append('cpf', document.getElementById('cadCpf').value);
        p.append('nascimento', document.getElementById('cadNasc').value);
        p.append('usuario', document.getElementById('cadUser').value);
        p.append('senha', document.getElementById('cadPass').value);
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: p });
        alert("Cadastro enviado! Tente logar.");
        irPara('telaLogin');
    }

    async function gravarOcorrencia() {
        const relato = document.getElementById('relatoTexto').value;
        if(!relato) return alert("Escreva o relato!");
        const p = new URLSearchParams();
        p.append('acao', 'salvarOcorrencia');
        p.append('professor', document.getElementById('nomeProfLogado').value);
        p.append('turma', document.getElementById('selTurma').value);
        p.append('aluno', document.getElementById('selAluno').value);
        p.append('texto', relato);
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: p });
        alert("‚úÖ Registro salvo com sucesso!");
        document.getElementById('relatoTexto').value = "";
    }

    async function consultarHistorico() {
        const al = document.getElementById('selAlunoCons').value;
        const profLogado = document.getElementById('nomeProfLogado').value;
        const resDiv = document.getElementById('resConsulta');
        if(!al) return alert("Selecione um aluno.");
        
        resDiv.innerHTML = "‚åõ Buscando hist√≥rico...";
        try {
            const res = await fetch(`${SCRIPT_URL}?acao=getDados`);
            const data = await res.json();
            const filtrados = data.filter(r => r[4] === al);
            
            if(filtrados.length === 0) {
                resDiv.innerHTML = "<p>Nenhum registro encontrado.</p>";
                document.getElementById('btnImp').style.display = "none";
            } else {
                let html = `<h2 style="color:var(--blue); border-bottom: 2px solid var(--blue); margin-top:20px; padding-bottom:10px">Hist√≥rico: ${al}</h2>`;
                html += filtrados.map(r => {
                    const id = String(r[0]);
                    const podeApagar = (r[2] === profLogado);
                    
                    // CORRE√á√ÉO DA DATA:
                    let dataFormatada = r[1];
                    const dataObj = new Date(r[1]);
                    // Se r[1] for uma data ISO (cont√©m "-"), formata para o padr√£o BR
                    if (!isNaN(dataObj) && String(r[1]).includes("-")) {
                        dataFormatada = dataObj.toLocaleDateString('pt-BR');
                    }

                    return `
                        <div class="item-ocorrencia" id="card-${id}">
                            ${podeApagar ? `<button onclick="apagarRegistro('${id}')" style="float:right; background:red; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">Apagar</button>` : ''}
                            <strong>Data:</strong> ${dataFormatada} | <strong>Prof:</strong> ${r[2]}<br><br>
                            ${r[5]}
                        </div>
                    `;
                }).join('');
                resDiv.innerHTML = html;
                document.getElementById('btnImp').style.display = "block";
            }
        } catch (e) { resDiv.innerHTML = "Erro ao carregar dados."; }
    }

    async function apagarRegistro(id) {
        if (!confirm("Confirmar exclus√£o definitiva do registro #" + id + "?")) return;
        const card = document.getElementById(`card-${id}`);
        if (card) card.style.opacity = "0.3";
        const p = new URLSearchParams();
        p.append('acao', 'apagarOcorrencia');
        p.append('id', id);
        try {
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: p });
            if (card) card.remove();
            alert("Registro removido com sucesso.");
        } catch (e) { alert("Erro ao conectar com a planilha."); }
    }
</script>

</body>
</html>