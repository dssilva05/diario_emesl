<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Di√°rio de Bordo - E. M. Etelvino Souza Lima</title>
    <style>
        :root { --blue: #0d47a1; --gold: #ffd600; --glass: rgba(255, 255, 255, 0.95); }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1497633762265-9d179a990aa6?q=80') center/cover fixed; min-height: 100vh; }
        header { background: var(--blue); color: white; padding: 15px 3%; display: flex; align-items: center; justify-content: space-between; border-bottom: 4px solid var(--gold); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .img-topo { width: 80px; height: 80px; object-fit: contain; background: white; border-radius: 8px; padding: 5px; }
        .escola-txt { text-align: center; flex-grow: 1; padding: 0 15px; }
        .escola-txt h1 { margin: 0; font-size: 20px; text-transform: uppercase; }
        .escola-txt p { margin: 5px 0 0; font-size: 12px; opacity: 0.9; line-height: 1.4; }
        .auth-wrapper { display: flex; justify-content: center; align-items: center; padding: 40px 20px; }
        .box-auth { background: white; padding: 30px; border-radius: 12px; width: 100%; max-width: 350px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); text-align: center; }
        .container { max-width: 650px; margin: 20px auto; padding: 15px; }
        .tabs { display: flex; background: rgba(255,255,255,0.2); border-radius: 12px 12px 0 0; backdrop-filter: blur(10px); padding: 5px 5px 0; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; color: white; cursor: pointer; font-weight: bold; border-radius: 8px 8px 0 0; }
        .tab-btn.active { background: var(--glass); color: var(--blue); }
        .card { background: var(--glass); padding: 25px; border-radius: 0 0 12px 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .hidden { display: none !important; }
        label { display: block; margin-top: 15px; font-weight: bold; color: #333; }
        input, select, textarea, .btn-main { width: 100%; padding: 12px; margin-top: 8px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 15px; }
        .btn-main { background: var(--blue); color: white; font-weight: bold; cursor: pointer; border: none; transition: 0.3s; }
        .btn-main:hover { background: #1565c0; }
        .btn-link { background: none; border: none; color: var(--blue); text-decoration: underline; cursor: pointer; margin-top: 15px; font-size: 14px; width: auto; }
        .titulo-trimestre { background: var(--gold); color: #000; padding: 8px 15px; margin-top: 25px; border-radius: 6px; font-weight: bold; border-left: 10px solid var(--blue); }
        .item-ocorrencia { background: white; padding: 15px; border-left: 5px solid var(--blue); margin-top: 10px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; }
        
        /* Estilos Checkbox Corrigidos */
        .filtro-box { margin-top: 15px; background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #ccc; display: flex; flex-direction: column; gap: 12px; }
        .filtro-item { display: flex; align-items: center; cursor: pointer; font-size: 14px; color: #444; }
        .filtro-item input { width: 18px; height: 18px; margin: 0 12px 0 0; cursor: pointer; }

        /* Suporte e Ajuda */
        .btn-ajuda-fixo { position: fixed; bottom: 20px; right: 20px; background: #25d366; color: white; padding: 10px 20px; border-radius: 30px; display: flex; align-items: center; gap: 10px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; z-index: 9999; border: none; }
        .modal-ajuda { position: fixed; bottom: 90px; right: 20px; width: 280px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 9999; text-align: left; }
        .modal-ajuda h3 { margin: 0 0 10px; color: var(--blue); font-size: 18px; }
        .modal-ajuda input { margin-bottom: 10px; font-size: 14px; }
        
        @media print { body { background: white !important; } header { display: flex !important; border-bottom: 2px solid #000 !important; color: black !important; } .tabs, .btn-main, label, select, .box-auth, button, .btn-link, .btn-ajuda-fixo, .modal-ajuda, .filtro-box { display: none !important; } .container { max-width: 100% !important; margin: 0 !important; padding: 0 !important; } .card { box-shadow: none !important; background: white !important; } .titulo-trimestre { border: 1px solid #000 !important; background: #eee !important; margin-top: 20px !important; } }
    </style>
</head>
<body>

<header>
    <img src="https://lh3.googleusercontent.com/u/0/d/150ASiCvLEftWk_IhH0GIVMyURJe76Epn" alt="Prefeitura" class="img-topo">
    <div class="escola-txt">
        <h1>Escola Municipal Etelvino Souza Lima</h1>
        <p>Avenida Engenheiro Felipe Gabrich, 19, Santa Matilde, Santa Luzia - MG.<br>CEP: 33025-220</p>
    </div>
    <img src="https://lh3.googleusercontent.com/u/0/d/1gaz-GsE-IJImjjWwG3Im4XoMLOraCSTh" alt="Escola" class="img-topo">
</header>

<div id="secaoAcesso" class="auth-wrapper">
    <div id="telaLogin" class="box-auth">
        <h2 style="color:var(--blue)">üîí Login</h2>
        <input type="text" id="userLogin" placeholder="Usu√°rio">
        <input type="password" id="passLogin" placeholder="Senha">
        <button class="btn-main" onclick="executarLogin()">Entrar</button>
        <button class="btn-link" onclick="irPara('telaCadastro')">Primeiro Acesso / Recuperar</button>
    </div>
    <div id="telaCadastro" class="box-auth hidden">
        <h2 style="color:var(--blue)">üìù Cadastro</h2>
        <input type="text" id="cadCpf" placeholder="CPF (n√∫meros)">
        <input type="text" id="cadNasc" placeholder="Nascimento (DD/MM/AAAA)">
        <input type="text" id="cadUser" placeholder="Usu√°rio">
        <input type="password" id="cadPass" placeholder="Senha">
        <button class="btn-main" onclick="executarCadastro()">Validar e Gravar</button>
        <button class="btn-link" onclick="irPara('telaLogin')">Voltar</button>
    </div>
</div>

<div id="conteudoDiario" class="container hidden">
    <div class="tabs">
        <button id="t1" class="tab-btn active" onclick="tab(1)">üìù INCLUIR</button>
        <button id="t2" class="tab-btn" onclick="tab(2)">üîç CONSULTAR</button>
        <button onclick="logout()" style="background:none; color:white; flex:0.3; cursor:pointer">Sair</button>
    </div>
    <div class="card">
        <div id="aba1">
            <label>Respons√°vel:</label>
            <input type="text" id="nomeProfLogado" readonly style="background:#e9ecef">
            <label>Data:</label>
            <input type="date" id="dataOcorrenciaManual">
            <label>Turma:</label>
            <select id="selTurma" onchange="atualizarAlunos('selTurma', 'selAluno')"><option value="">Carregando...</option></select>
            <label>Aluno:</label>
            <select id="selAluno"><option value="">Selecione a turma...</option></select>
            <label>Relato:</label>
            <textarea id="relatoTexto" rows="5"></textarea>
            <button class="btn-main" id="btnGravar" onclick="gravarOcorrencia()">Gravar no Di√°rio</button>
        </div>

        <div id="aba2" class="hidden">
            <label>Turma:</label>
            <select id="selTurmaCons" onchange="atualizarAlunos('selTurmaCons', 'selAlunoCons')"><option value="">Carregando...</option></select>
            <label>Aluno:</label>
            <select id="selAlunoCons" style="margin-top:10px;"><option value="">Selecione a turma...</option></select>
            <label>Per√≠odo:</label>
            <select id="selPeriodoCons" style="margin-top:10px;">
                <option value="Ano Todo">Ano Todo (Todos os Trimestres)</option>
                <option value="1¬∫ Trimestre">1¬∫ Trimestre</option>
                <option value="2¬∫ Trimestre">2¬∫ Trimestre</option>
                <option value="3¬∫ Trimestre">3¬∫ Trimestre</option>
            </select>

            <div class="filtro-box">
                <label class="filtro-item">
                    <input type="checkbox" id="chkMeusRegistros" checked onclick="alternarCheckboxes('meu')"> 
                    Ver apenas minhas ocorr√™ncias
                </label>
                <label class="filtro-item">
                    <input type="checkbox" id="chkTodosRegistros" onclick="alternarCheckboxes('todos')"> 
                    Ver todas as ocorr√™ncias
                </label>
            </div>

            <button class="btn-main" style="margin-top: 20px;" onclick="consultarHistorico()">üîç Buscar Hist√≥rico</button>
            <div id="areaImpressao"><div id="resConsulta"></div></div>
            <button class="btn-main" id="btnImp" style="background:#444; display:none; margin-top:20px" onclick="window.print()">üñ®Ô∏è PDF / Imprimir</button>
        </div>
    </div>
</div>

<button class="btn-ajuda-fixo" onclick="toggleAjuda()">üí° D√∫vidas?</button>
<div id="caixaAjuda" class="modal-ajuda hidden">
    <h3>Suporte T√©cnico</h3>
    <input type="text" id="escolaDuvida" value="E. M. Etelvino Souza Lima" readonly style="background:#f0f0f0;">
    <input type="text" id="nomeDuvida" placeholder="Seu nome completo">
    <textarea id="textoDuvida" id="textoDuvida" rows="4" placeholder="Descreva sua d√∫vida..."></textarea>
    <button class="btn-main" style="background:#25d366; margin-top: 10px;" onclick="enviarWhatsApp()">Enviar via WhatsApp</button>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz69grSXw5sBpm39kV1UB7rn8B4ycQdvf2CET6VtbK3TLBVh1RzrcrnpxfNUDcZ5vobbg/exec"; 
    let ALUNOS = {};
    let cargoLogado = "", profNomeLogado = "", disciplinaLogada = "", idEditando = null;

    window.onload = function() {
        const salvo = localStorage.getItem('diarioAcesso');
        if (salvo) aplicarLogin(JSON.parse(salvo));
        carregarDadosIniciais();
    };

    async function carregarDadosIniciais() {
        try {
            const res = await fetch(`${SCRIPT_URL}?acao=getListaAlunos`);
            ALUNOS = await res.json();
            const selects = [document.getElementById('selTurma'), document.getElementById('selTurmaCons')];
            const turmas = Object.keys(ALUNOS).sort();
            selects.forEach(sel => {
                sel.innerHTML = '<option value="">Selecione a Turma...</option>';
                turmas.forEach(t => sel.add(new Option(t, t)));
            });
        } catch (e) { console.error(e); }
    }

    function atualizarAlunos(idT, idA) {
        const t = document.getElementById(idT).value;
        const s = document.getElementById(idA);
        s.innerHTML = '<option value="">Selecione o Aluno...</option>';
        if(ALUNOS[t]) {
            // A lista vem pronta da planilha (incluindo "Turma Toda" se houver)
            ALUNOS[t].forEach(al => s.add(new Option(al, al)));
        }
    }

    function alternarCheckboxes(quem) {
        const cMeu = document.getElementById('chkMeusRegistros');
        const cTodos = document.getElementById('chkTodosRegistros');
        if (quem === 'meu' && cMeu.checked) cTodos.checked = false;
        else if (quem === 'todos' && cTodos.checked) cMeu.checked = false;
        if (!cMeu.checked && !cTodos.checked) cMeu.checked = true;
    }

    async function executarLogin() {
        const u = document.getElementById('userLogin').value, s = document.getElementById('passLogin').value;
        try {
            const res = await fetch(`${SCRIPT_URL}?acao=login&usuario=${u}&senha=${s}`);
            const d = await res.json();
            if(d.status === "Autorizado") { localStorage.setItem('diarioAcesso', JSON.stringify(d)); aplicarLogin(d); }
            else alert("Acesso negado.");
        } catch (e) { alert("Erro de conex√£o."); }
    }

    function aplicarLogin(d) {
    profNomeLogado = d.nome;
    disciplinaLogada = d.disciplina;
    
    // Lista de cargos que t√™m permiss√£o total de edi√ß√£o
    const cargosGestores = [
        "diretor", "diretora", 
        "vice-diretor", "vice-diretora", 
        "coordenador", "coordenadora", 
        "supervisor", "supervisora"
    ];

    // Verifica se o que est√° escrito no Cargo (Coluna F) ou Disciplina (Coluna G) 
    // coincide com algum cargo da lista acima
    const eGestor = cargosGestores.some(cargo => 
        d.cargo.toLowerCase().includes(cargo) || 
        d.disciplina.toLowerCase().includes(cargo)
    );

    cargoLogado = eGestor ? "Diretor" : "Professor";

    document.getElementById('secaoAcesso').classList.add('hidden');
    document.getElementById('conteudoDiario').classList.remove('hidden');
    document.getElementById('nomeProfLogado').value = profNomeLogado;

    if(cargoLogado === "Diretor") { 
        document.getElementById('nomeProfLogado').readOnly = false; 
        document.getElementById('nomeProfLogado').style.background = "#fff"; 
    }
    definirDataHoje();
}

    async function gravarOcorrencia() {
    const dVal = document.getElementById('dataOcorrenciaManual').value;
    if(!dVal) return alert("Selecione a data!");
    
    const [ano, mes, dia] = dVal.split("-");
    const dFormat = `${dia}/${mes}/${ano}`;
    const nomeInput = document.getElementById('nomeProfLogado').value;
    const primNome = nomeInput.split(" ")[0];

    // Formata√ß√£o especial para a Diretoria
    let nomeFinal;
    if (cargoLogado === "Diretor") {
        // Usa o que estiver na disciplina (ex: Diretora) entre par√™nteses
        nomeFinal = `Prof(a): ${primNome} (${disciplinaLogada})`;
    } else {
        nomeFinal = `Prof(a): ${primNome} (${disciplinaLogada})`;
    }

    const p = new URLSearchParams();
    p.append('acao', idEditando ? 'editarOcorrencia' : 'salvarOcorrencia');
    if(idEditando) p.append('id', idEditando);
    p.append('professor', nomeFinal);
    p.append('dataManual', dFormat);
    p.append('turma', document.getElementById('selTurma').value);
    p.append('aluno', document.getElementById('selAluno').value);
    p.append('texto', document.getElementById('relatoTexto').value);

    await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: p });
    alert("Sucesso!");
    cancelarEdicao();
    document.getElementById('relatoTexto').value = "";
    definirDataHoje();
}

    async function consultarHistorico() {
    const t = document.getElementById('selTurmaCons').value, a = document.getElementById('selAlunoCons').value;
    const p = document.getElementById('selPeriodoCons').value, vT = document.getElementById('chkTodosRegistros').checked;
    const rDiv = document.getElementById('resConsulta');
    
    if (!t || !a) return alert("Selecione Turma e Aluno.");
    rDiv.innerHTML = "Buscando...";
    
    try {
        const res = await fetch(`${SCRIPT_URL}?acao=getDados`);
        const data = await res.json();
        
        // 1. Filtro inicial por Turma e Aluno
        let filtrados = data.filter(r => r[3] && r[4] && String(r[3]).trim() === t && String(r[4]).trim() === a);
        
        // 2. ORDENA√á√ÉO POR DATA (Da menor para a maior)
        filtrados.sort((a, b) => {
            const converterData = (txt) => {
                const partes = txt.split('/');
                // Retorna um objeto de data YYYY-MM-DD para compara√ß√£o correta
                return new Date(partes[2], partes[1] - 1, partes[0]);
            };
            return converterData(a[1]) - converterData(b[1]);
        });

        // 3. Filtro por Per√≠odo (Trimestre)
        if (p !== "Ano Todo") filtrados = filtrados.filter(r => identificarTrimestre(r[1]) === p);
        
        // 4. Filtro por Professor (Apenas meus ou todos)
        if (!vT) {
            const meu = profNomeLogado.split(" ")[0];
            filtrados = filtrados.filter(r => String(r[2]).includes(meu));
        }

        if (filtrados.length === 0) { rDiv.innerHTML = "Nada encontrado."; return; }

        // Organiza√ß√£o Visual por Trimestre
        let grupos = { "1¬∫ Trimestre": [], "2¬∫ Trimestre": [], "3¬∫ Trimestre": [], "Fora de Per√≠odo": [] };
        filtrados.forEach(r => {
            const tri = identificarTrimestre(r[1]);
            if(grupos[tri]) grupos[tri].push(r);
            else grupos["Fora de Per√≠odo"].push(r);
        });

        let html = `<h2>Hist√≥rico: ${a}</h2>`;
        for (let tri in grupos) {
            if (grupos[tri].length > 0) {
                html += `<div class="titulo-trimestre">${tri}</div>`;
                grupos[tri].forEach(r => {
                    const pode = (String(r[2]).includes(profNomeLogado.split(" ")[0]) || cargoLogado === "Diretor");
                    html += `<div class="item-ocorrencia" id="card-${r[0]}">
                        ${pode ? `<button onclick="apagarRegistro('${r[0]}')" style="float:right; background:red; color:white; border:none; padding:5px; border-radius:5px; margin-left:5px">Apagar</button>
                        <button onclick="carregarParaEdicao('${r[0]}','${r[1]}','${r[3]}','${r[4]}','${r[5]}')" style="float:right; background:orange; border:none; padding:5px; border-radius:5px">Editar</button>` : ''}
                        <strong>Data:</strong> ${r[1]} | <strong>${r[2]}</strong><br><br>${r[5]}
                    </div>`;
                });
            }
        }
        rDiv.innerHTML = html; 
        document.getElementById('btnImp').style.display = "block";
    } catch (e) { 
        console.error(e);
        rDiv.innerHTML = "Erro t√©cnico ao carregar os dados."; 
    }
}

    function identificarTrimestre(ds) {
        const p = ds.split('/'); const d = new Date(p[2], p[1]-1, p[0]);
        if (d >= new Date(2026, 1, 4) && d <= new Date(2026, 4, 15)) return "1¬∫ Trimestre";
        if (d >= new Date(2026, 4, 18) && d <= new Date(2026, 7, 31)) return "2¬∫ Trimestre";
        if (d >= new Date(2026, 8, 1) && d <= new Date(2026, 11, 15)) return "3¬∫ Trimestre";
        return "Fora de Per√≠odo";
    }

    function tab(n) { document.getElementById('aba1').classList.toggle('hidden', n !== 1); document.getElementById('aba2').classList.toggle('hidden', n !== 2); document.getElementById('t1').classList.toggle('active', n === 1); document.getElementById('t2').classList.toggle('active', n === 2); if(n===2) cancelarEdicao(); }
    function irPara(id) { document.getElementById('telaLogin').classList.add('hidden'); document.getElementById('telaCadastro').classList.add('hidden'); document.getElementById(id).classList.remove('hidden'); }
    function definirDataHoje() { document.getElementById('dataOcorrenciaManual').value = new Date().toISOString().split('T')[0]; }
    function toggleAjuda() { document.getElementById('caixaAjuda').classList.toggle('hidden'); }
    function logout() { localStorage.removeItem('diarioAcesso'); location.reload(); }
    function cancelarEdicao() { idEditando = null; const b = document.getElementById('btnGravar'); b.innerText = "Gravar no Di√°rio"; b.style.background = ""; }
    
    function carregarParaEdicao(id, data, turma, aluno, texto) {
        idEditando = id; tab(1); const p = data.split('/');
        document.getElementById('dataOcorrenciaManual').value = `${p[2]}-${p[1]}-${p[0]}`;
        document.getElementById('selTurma').value = turma; atualizarAlunos('selTurma', 'selAluno');
        setTimeout(() => document.getElementById('selAluno').value = aluno, 150);
        document.getElementById('relatoTexto').value = texto;
        const b = document.getElementById('btnGravar'); b.innerText = "üíæ Salvar Altera√ß√£o"; b.style.background = "orange";
    }

    async function enviarWhatsApp() {
        const tel = "5531975580836";
        const esc = document.getElementById('escolaDuvida').value;
        let nom = document.getElementById('nomeDuvida').value || profNomeLogado;
        const duv = document.getElementById('textoDuvida').value;
        if (!nom || !duv) return alert("Preencha nome e d√∫vida.");
        const msg = `*Suporte Di√°rio*\n*Escola:* ${esc}\n*De:* ${nom}\n*D√∫vida:* ${duv}`;
        window.open(`https://api.whatsapp.com/send?phone=${tel}&text=${encodeURIComponent(msg)}`, '_blank');
        toggleAjuda();
    }

    async function apagarRegistro(id) {
        if (!confirm("Excluir?")) return;
        const p = new URLSearchParams(); p.append('acao', 'apagarOcorrencia'); p.append('id', id);
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: p });
        document.getElementById(`card-${id}`).remove();
    }
</script>
</body>
</html>
